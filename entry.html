<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang='en'>
<meta http-equiv='Content-Language' content='en'>
<script type='text/javascript' src='jquery-3.3.1.min.js'></script>
<head>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
<style>
body {
  font-family: serif;
  font-size: 16px;
}
.label {
  text-align: right;
}
.disabled {
  color: lightgray;
}
button {
  width: 100%;
  font-weight: 700;
}
.event, .event th, .event td {
  border: 1px solid black;
  border-collapse: collapse;
}
.event tbody tr td, .event thead tr th {
  text-align: center;
  width: auto;
}
.dynawidth {
  display: inline-block;
  font-family: serif;
  font-weight: 700;
  font-size: 16px;
  border: none;
}
</style>
<script>

function onLocationChange() {
  var locations = $("textarea[name='locations']").val().split("\n");
  var times = $("textarea[name='times']").val().split("\n");
  console.log(locations);
  console.log(times);
  var headerrow = "<tr><th></th>";
  var checkrow = "";
  for (var col = 0; col < times.length; col++) {
    headerrow += `<th>${times[col]}</th>`;
    checkrow += "<td><input type='checkbox' checked></td>";
  }
  headerrow += "</tr>";
  console.log(headerrow);
  $('.matrix thead').html(headerrow);
  for (var row = 0; row < locations.length; row++) {
    var newrow = `<tr><td><b>${locations[row]}</b></td>${checkrow}</tr>`;
    console.log(newrow);
    $('.matrix tbody').append(newrow);
  }
}
function onTimeChange() { onLocationChange() }

teams = [];

function onExcelPaste() {
  var data = $('textarea[name=excel_data]').val();
    console.log(data);
  var rows = data.split("\n");

teams = [];
  var table = $('<table />');
  for(var y in rows) {
      var cells = rows[y].split("\t");
teams[y] = { club: cells[0], team: cells[1], friendlyName: cells[2], code: cells[3], points: cells[5] };
      var row = $('<tr />');
      for(var x in cells) {
          row.append('<td>'+cells[x]+'</td>');
      }
      table.append(row);
  }

  // Insert into DOM
  $('#excel_table').html(table);
}

var request = new XMLHttpRequest();

function SendData() {
console.log(`readyState: ${request.readyState}, status: ${request.status}`);
  if (request.readyState == 4 && request.status == 200) {
    alert('Data sent...\n');
  } else {
    alert('Connection FAIL,\nCheck connection and Retry!!!');
    console.log(request);
  }
}
function SendDataToServer(data) {
  var url = 'http:/localhost:4242/server.js';
  request.open('POST', url, true);
  request.onreadystatechange = SendData;
  request.send(data);
}

function GatherLocationsAndTimes() {
  var locations = $("textarea[name='locations']").val().split('\n');
  var times = $("textarea[name='times']").val().split('\n');
  var tablerow = $('.matrix tbody tr:first-child');
  var locationsAndTimes = [];
  var location = 0;
  $('.matrix tbody tr').each(function() {
    var time = 0;
    $('td', this).each(function() {
      locationsAndTimes.push({
        location: locations[location],
        time: times[time],
      });
      time++;
    });
    location++;
  });
  return locationsAndTimes;
}

function SendEntryDataToServer() {
  var name = $("input[name='name']").val();
  var date = $("input[name='date']").val();
  var dateFormat = $('#dateformats').val();
  var locationsAndTimes = GatherLocationsAndTimes();
  var entryData = {
    name: name,
    date: date,
    dateFormat: dateFormat,
    locationsAndTimes: locationsAndTimes,
    teams: teams,
  };
console.log(entryData);
  var postData = JSON.stringify(entryData);
  SendDataToServer(postData);

  return false; // ???
}

function GetLang() {
  if (navigator.languages && navigator.languages.length) {
    return navigator.languages[0];
  } else {
    return navigator.userLanguage || navigator.language || navigator.browserLanguage || 'en-US';
  }
}
dateOptions = [
  { year: 'numeric', month: 'long', day: 'numeric' },
  { year: '2-digit', month: 'numeric', day: 'numeric'},
  { year: 'numeric', month: 'numeric', day: 'numeric'},
];
function onDateChange() {
  $('#dateformats').children('option').remove();
  $.each(dateOptions, function(index, value){
    console.log(value);
    console.log($("input[name='date']").val());
    var format = new Date($("input[name='date']").val() + 'T00:00:00');
    console.log(format);
    $('#dateformats').append($('<option>', { 'value': index, 'text': format.toLocaleDateString(GetLang(), value) }));
  });
}
// https://ntrvolleyball.net/wp-content/uploads/2017/08/Power-Pool-Format-Information-1.pdf
//    Teams : Power Pools, Teams per Power Pool
//    <= 12 :      0     ,          0
// 13 <= 16 :      1     ,          3
// 17 <= 24 :      1     ,          4
// 25 <= 32 :      2     ,          3
// 33 <=    :      2     ,          4

// From: https://codepen.io/Momciloo/pen/bpyMbB (no spaces w/input)
//       & http://jsfiddle.net/philfreo/MqM76/
$.fn.GetTextWidth = function(text, font) {
  if (!$.fn.GetTextWidth.tempSpan)
    $.fn.GetTextWidth.tempSpan = $('<span>').hide().appendTo(document.body);
  $.fn.GetTextWidth.tempSpan
   .text(text || this.val() || this.text() || this.attr('placeholder'))
   .css('font', font || this.css('font'));
  return $.fn.GetTextWidth.tempSpan.width();
};

// https://stackoverflow.com/a/841121
$.fn.SelectRange = function(start, end) {
  if(end === undefined) {
    end = start;
  }
  return this.each(function() {
    if('selectionStart' in this) {
      this.selectionStart = start;
      this.selectionEnd = end;
    } else if(this.setSelectionRange) {
      this.setSelectionRange(start, end);
    } else if(this.createTextRange) {
      var range = this.createTextRange();
      range.collapse(true);
      range.moveEnd('character', end);
      range.moveStart('character', start);
      range.select();
    }
  });
};

function VirtIdxToRealIdx($tr, virtIdx) {
  var realIdx = 0;
  $tr.children('th').each(function (i, th) {
    if (i < virtIdx)
      realIdx += parseInt($(th).attr('colspan')) || 1;
    else
      return false;
  });
  return realIdx;
}

function RealIdxToVirtIdx($tr, realIdx) {
  var virtIdx = 0;
  var chkRealIdx = 0;
  var th, colspan;
  while (true) {
    th = $tr.children('th').eq(virtIdx);
    colspan = parseInt($(th).attr('colspan')) || 1;
    chkRealIdx += colspan;
    if (realIdx < chkRealIdx)
      break;
    virtIdx++;
  }
  return virtIdx;
}

function scanTable( $table ) {
  var m = [];
  $table.children( "tr" ).each( function( y, row ) {
    $( row ).children( "td, th" ).each( function( x, cell ) {
      var $cell = $( cell ),
          cspan = ($cell.attr( "colspan" ) | 0) || 1,
          rspan = ($cell.attr( "rowspan" ) | 0) || 1;
      for( ; m[y] && m[y][x]; ++x );
      for( var tx = x; tx < x + cspan; ++tx ) {
        for( var ty = y; ty < y + rspan; ++ty ) {
          if( !m[ty] ) {
            m[ty] = [];
          }
          m[ty][tx] = true;
        }
      }
      var pos = { left: x, top: y };
      $cell.data( "cellPos", pos );
    } );
  } );
};

$.fn.cellPos = function( rescan ) {
  var $cell = this.first(),
      pos = $cell.data( "cellPos" );
  if( !pos || rescan ) {
    var $table = $cell.closest( "table, thead, tbody, tfoot" );
    scanTable( $table );
    pos = $cell.data( "cellPos" );
  }
  return pos;
}

$.fn.cellFromPos = function(pos) {
  var $table = this.closest('th').closest('table');
  var $row = $table.find('tr').eq(pos.top); // assumes a tr for each row
  var $cell = null;
  $row.find('th').each(function(i, e) {
    var cellPos = $(e).data('cellPos');
    if (cellPos.left >= pos.left && cellPos.top >= pos.top) {
      $cell = $(e);
      return false;
    }
  });
  return $cell;
}

$(document).ready(function() {

  scanTable($('event'));

  $('.dynawidth').on('input', function() {
    var paddingAndBorder = $(this).outerWidth() - $(this).width();
    var inputWidth = $(this).GetTextWidth() + paddingAndBorder;
    $(this).css({
      width: inputWidth
    })
  }).trigger('input');

  $('.dynawidth').keydown(function(e) {
    var key = e.which;
    var text = $(this).val();
    var pos = this.selectionStart;
    switch (key) {
      case 8: // [Backspace]
        if (text.length <= 0) {
          e.preventDefault();
          // Delete this header (unless only in this row) and move to previous in this row (unless first)
        }
        break;
      // case 9: // [Tab]
      //   // Move to next header in this row (unless last)
      //   break;
      // case 16: // [Shift]+[Tab]
      //   // Move to previous header in this row (unless first)
      //   break;
      case 37: // [←] (left arrow)
        if (pos <= 0) {
          e.preventDefault();
          // Move to previous header in this row (unless first)
//          var div = $(document.activeElement).closest('th').prev().children('.dynawidth');
//          if (div[0]) {
//            div.focus();
//            div.SelectRange(div.val().length);
//          }
var $thiscell = $(this).closest('th');
console.log("$thiscell: ", $thiscell);
var thispos = $thiscell.cellPos();
console.log("thispos:", thispos);
var prevpos = { left: thispos.left - 1, top: thispos.top };
console.log("prevpos:", prevpos);
if (prevpos.left < 0)
  prevpos.left = 0;
var $prevcell = $(this).cellFromPos(prevpos);
console.log("$prevcell: ", $prevcell);
var $previn = $($prevcell.children('.dynawidth')[0]);
console.log("$previn: ", $previn);
if ($previn.length) {
  console.log("HERE!!");
  $previn.focus();
  $previn.SelectRange($previn.val().length);
}
        }
        break;
      case 38: // [↑] (up arrow)
        e.preventDefault();
        // Move to previous header row (unless first)
        var thisth = $(this).closest('th');
        var thistr = $(this).closest('tr');
        var prevtr = thistr.prev('tr');
        var newidx = RealIdxToVirtIdx(prevtr, VirtIdxToRealIdx(thistr, thisth.index()));
        if (prevtr.length)
          prevtr.children('th').eq(newidx).children('.dynawidth').focus();
        break;
      case 39: // [→] (right arrow)
        if (pos >= text.length) {
          e.preventDefault();
          // Move to next header in this row (unless last)
          $(document.activeElement).closest('th').next().children('.dynawidth').focus();
        }
        break;
      case 40: // [↓] (down arrow)
        e.preventDefault();
        // Move to next header row (unless last)
        var thisth = $(this).closest('th');
        var thistr = $(this).closest('tr');
        var nexttr = thistr.next('tr');
        var newidx = RealIdxToVirtIdx(nexttr, VirtIdxToRealIdx(thistr, thisth.index()));
        if (nexttr.length)
          nexttr.children('th').eq(newidx).children('.dynawidth').focus();
        break;
      case 46: // [Delete]
        if (text.length <= 0) {
          e.preventDefault();
          // Delete this header (unless only in this row) and move to next in this row (unless last)
        }
        break;
    }
  });
  $('.dynawidth').keyup(function(e) {
    console.log(e);
    var key = e.which;
    var text = $(this).val();
    var pos = this.selectionStart;
    console.log(`text: ${text}`);
    console.log(`text length: ${text.length}`);
    console.log(`char: ${e.which}`);
    console.log(`cursor: ${pos}`);
    switch (key) {
      case 13: // [Enter]
        e.preventDefault();
        // Create a new header in this row/column
        break;
    }
  });

});

// dates/times
// venues/locations
// rows & columns

</script>
</head>
<body>
  <form>
    <!--
      [key to track tourney]
      Pool name
      Pool date
      Location/time table
      Table entry field
      Power pools (default ULR?)
      Teams per pool (default 4)
      Pools (default teams / 4)
      Submit button
    -->
    <table><tbody>
      <tr>
        <td class='label'>Event Name:</td>
        <td><input type='text' name='name'></td>
      </tr>
      <tr>
        <td class='label'>Event Date:</td>
        <td><input type='date' name='date' onchange='onDateChange()'>&nbsp;Format:&nbsp;<select id='dateformats'></select></td>
      </tr>
      <tr>
        <td class='label'>Power Pools:</td>
        <td><input type='checkbox'></td>
      </tr>
      <tr>
        <td class='label disabled'>Number of Power Pools:</td>
        <td><input type='number' min='0' max='2' step='1' value='0' disabled></td>
      </tr>
      <tr>
        <td class='label disabled'>Teams per Power Pool:</td>
        <td><input type='number' min='3' max='4' value='3' disabled></td>
      </tr>
      <tr>
        <td class='label'>Locations:</td>
        <td><textarea name="locations" cols="40" rows="6" onchange='onLocationChange()'></textarea></td>
      </tr>
      <tr>
        <td class='label'>Times:</td>
        <td><textarea name="times" cols="10" rows="2" onchange='onTimeChange()'>8:00 AM&NewLine;3:00 PM</textarea></td>
      </tr>
      <tr><td colspan='2'>
        <table class='matrix'>
          <thead></thead>
          <tbody></tbody>
        </table>
      </td></tr>
      <tr>
        <td class='label'>Paste Team List Here:</td>
        <td><textarea name='excel_data' cols='20' rows='1' onchange='onExcelPaste()'></textarea></td>
      </tr>

      <tr><td colspan='2'>
        <table class='event'>
          <thead>
            <tr><th colspan='2'></th><th colspan='2'><input type='text' class='dynawidth' value='May 5, 2018'></th><th colspan='2'><input type='text' class='dynawidth' value='May 6, 2018'></th></tr>
            <tr><th colspan='2'></th><th><input type='text' class='dynawidth' value='8:00 AM'></th><th><input type='text' class='dynawidth' value='3:00 PM'></th><th><input type='text' class='dynawidth' value='8:00 AM'></th><th><input type='text' class='dynawidth' value='3:00 PM'></th></tr>
          </thead>
          <tbody>
            <tr><th rowspan='2'><input type='text' class='dynawidth' value='Venue 1'></th><th><input type='text' class='dynawidth' value='Court 1'></th><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></tr>
            <tr><th><input type='text' class='dynawidth' value='Court 2'></th><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></tr>
            <tr><th rowspan='2'><input type='text' class='dynawidth' value='Venue 2'></th><th><input type='text' class='dynawidth' value='Court 1'></th><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></tr>
            <tr><th><input type='text' class='dynawidth' value='Court 2'></th><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></tr>
          </tbody>
        </table>
      </td></tr>

    </tbody></table>
    <br><input type="button" onclick="SendEntryDataToServer()" value="Generate Pools"/>
</form>
<div id='excel_table'></div>
</body>