<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang='en'>
<meta http-equiv='Content-Language' content='en'>
<script type='text/javascript' src='jquery-3.3.1.min.js'></script>
<head>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
<style>
body {
  font-family: serif;
  font-size: 16px;
}
.label {
  text-align: right;
}
.disabled {
  color: lightgray;
}
button {
  width: 100%;
  font-weight: 700;
}
.event, .event th, .event td {
  border: 1px solid black;
  border-collapse: collapse;
}
.event tbody tr td, .event thead tr th {
  text-align: center;
  width: auto;
}
.dynawidth {
  display: inline-block;
}
</style>
<script>

function onLocationChange() {
  var locations = $("textarea[name='locations']").val().split("\n");
  var times = $("textarea[name='times']").val().split("\n");
  console.log(locations);
  console.log(times);
  var headerrow = "<tr><th></th>";
  var checkrow = "";
  for (var col = 0; col < times.length; col++) {
    headerrow += `<th>${times[col]}</th>`;
    checkrow += "<td><input type='checkbox' checked></td>";
  }
  headerrow += "</tr>";
  console.log(headerrow);
  $('.matrix thead').html(headerrow);
  for (var row = 0; row < locations.length; row++) {
    var newrow = `<tr><td><b>${locations[row]}</b></td>${checkrow}</tr>`;
    console.log(newrow);
    $('.matrix tbody').append(newrow);
  }
}
function onTimeChange() { onLocationChange() }

teams = [];

function onExcelPaste() {
  var data = $('textarea[name=excel_data]').val();
    console.log(data);
  var rows = data.split("\n");

teams = [];
  var table = $('<table />');
  for(var y in rows) {
      var cells = rows[y].split("\t");
teams[y] = { club: cells[0], team: cells[1], friendlyName: cells[2], code: cells[3], points: cells[5] };
      var row = $('<tr />');
      for(var x in cells) {
          row.append('<td>'+cells[x]+'</td>');
      }
      table.append(row);
  }

  // Insert into DOM
  $('#excel_table').html(table);
}

var request = new XMLHttpRequest();

function SendData() {
console.log(`readyState: ${request.readyState}, status: ${request.status}`);
  if (request.readyState == 4 && request.status == 200) {
    alert('Data sent...\n');
  } else {
    alert('Connection FAIL,\nCheck connection and Retry!!!');
    console.log(request);
  }
}
function SendDataToServer(data) {
  var url = 'http:/localhost:4242/server.js';
  request.open('POST', url, true);
  request.onreadystatechange = SendData;
  request.send(data);
}

function GatherLocationsAndTimes() {
  var locations = $("textarea[name='locations']").val().split('\n');
  var times = $("textarea[name='times']").val().split('\n');
  var tablerow = $('.matrix tbody tr:first-child');
  var locationsAndTimes = [];
  var location = 0;
  $('.matrix tbody tr').each(function() {
    var time = 0;
    $('td', this).each(function() {
      locationsAndTimes.push({
        location: locations[location],
        time: times[time],
      });
      time++;
    });
    location++;
  });
  return locationsAndTimes;
}

function SendEntryDataToServer() {
  var name = $("input[name='name']").val();
  var date = $("input[name='date']").val();
  var dateFormat = $('#dateformats').val();
  var locationsAndTimes = GatherLocationsAndTimes();
  var entryData = {
    name: name,
    date: date,
    dateFormat: dateFormat,
    locationsAndTimes: locationsAndTimes,
    teams: teams,
  };
console.log(entryData);
  var postData = JSON.stringify(entryData);
  SendDataToServer(postData);

  return false; // ???
}

function GetLang() {
  if (navigator.languages && navigator.languages.length) {
    return navigator.languages[0];
  } else {
    return navigator.userLanguage || navigator.language || navigator.browserLanguage || 'en-US';
  }
}
dateOptions = [
  { year: 'numeric', month: 'long', day: 'numeric' },
  { year: '2-digit', month: 'numeric', day: 'numeric'},
  { year: 'numeric', month: 'numeric', day: 'numeric'},
];
function onDateChange() {
  $('#dateformats').children('option').remove();
  $.each(dateOptions, function(index, value){
    console.log(value);
    console.log($("input[name='date']").val());
    var format = new Date($("input[name='date']").val() + 'T00:00:00');
    console.log(format);
    $('#dateformats').append($('<option>', { 'value': index, 'text': format.toLocaleDateString(GetLang(), value) }));
  });
}
// https://ntrvolleyball.net/wp-content/uploads/2017/08/Power-Pool-Format-Information-1.pdf
//    Teams : Power Pools, Teams per Power Pool
//    <= 12 :      0     ,          0
// 13 <= 16 :      1     ,          3
// 17 <= 24 :      1     ,          4
// 25 <= 32 :      2     ,          3
// 33 <=    :      2     ,          4

//                    date 1
//                 time 1 time 2
//         court 1   o      o
// venue 1 court 2   o      o
//         [add]
// venue 2 court 1   o      o
//         [add]
//  [add]

//                    date 1
//                 time 1 time 2
//         court 1   o      o
// venue 1 court 2   o      o
// venue 2 court 1   o      o

// From: https://codepen.io/Momciloo/pen/bpyMbB (no spaces w/input)
//       & http://jsfiddle.net/philfreo/MqM76/
$.fn.GetTextWidth = function(text, font) {
  if (!$.fn.GetTextWidth.tempSpan)
    $.fn.GetTextWidth.tempSpan = $('<span>').hide().appendTo(document.body);
  $.fn.GetTextWidth.tempSpan
   .text(text || this.val() || this.text() || this.attr('placeholder'))
   .css('font', font || this.css('font'));
  return $.fn.GetTextWidth.tempSpan.width();
};

$(document).ready(function(){

  $('.dynawidth').on('input', function() {
    var inputWidth = $(this).GetTextWidth();
    $(this).css({
      width: inputWidth
    })
  }).trigger('input');

  $('.dynawidth').keydown(function(e) {
    curposondown = window.getSelection().anchorOffset;
  });
  $('.dynawidth').keyup(function(e) {
    console.log(e);
    var element = e.currentTarget;
    var key = e.which;
    var text = element.textContent;
    var pos = window.getSelection().anchorOffset;
    console.log(`text: ${text}`);
    console.log(`text length: ${text.length}`);
    console.log(`char: ${e.which}`);
    console.log(`cursor: ${pos}`);
    switch (key) {
      case 8: // [Backspace]
        if (text.length <= 0) {
          e.preventDefault();
          // Delete this header (unless only in this row) and move to previous in this row (unless first)
        }
        break;
      // case 9: // [Tab]
      //   // Move to next header in this row (unless last)
      //   break;
      case 13: // [Enter]
        e.preventDefault();
        // Create a new header in this row/column
        break;
      // case 16: // [Shift]+[Tab]
      //   // Move to previous header in this row (unless first)
      //   break;
      case 37: // [←] (left arrow)
        if (pos <= 0 && curposondown <= 0) {
          e.preventDefault();
          // Move to previous header in this row (unless first)
          var div = $(document.activeElement).closest('th').prev().children('.dynawidth');
          if (div) {
console.log(div);
            div.focus();
var sel, range;
if (window.getSelection && document.createRange) {
  range = document.createRange();
  range.selectNodeContents(div[0]);
range.setStart(div[0], 1);
range.setEnd(div[0], 1);
//  range.collapse(false);
//  sel = window.getSelection();
//  sel.removeAllRanges();
//  sel.addRange(range);
//div[0].removeAllRanges();
//div[0].addRange(range);
} else if (document.body.createTextRange) {
  range = document.body.createTextRange();
  range.moveToElementText(div[0]);
  range.collapse(false);
  range.select();
}
          }
        }
        break;
      case 38: // [↑] (up arrow)
        e.preventDefault();
        // Move to previous header row (unless first)
        break;
      case 39: // [→] (right arrow)
        if (pos >= text.length && curposondown >= text.length) {
          e.preventDefault();
          // Move to next header in this row (unless last)
          $(document.activeElement).closest('th').next().children('.dynawidth').focus();
          curposondown = 1000;
        }
        break;
      case 40: // [↓] (down arrow)
        e.preventDefault();
        // Move to next header row (unless last)
        break;
      case 46: // [Delete]
        if (text.length <= 0) {
          e.preventDefault();
          // Delete this header (unless only in this row) and move to next in this row (unless last)
        }
        break;
    }
  });

});

// dates/times
// venues/locations
// rows & columns

</script>
</head>
<body>
  <form>
    <table><tbody>
      <tr>
        <td class='label'>Event Name:</td>
        <td><input type='text' name='name'></td>
      </tr>
      <tr>
        <td class='label'>Event Date:</td>
        <td><input type='date' name='date' onchange='onDateChange()'>&nbsp;Format:&nbsp;<select id='dateformats'></select></td>
      </tr>
      <tr>
        <td class='label'>Power Pools:</td>
        <td><input type='checkbox'></td>
      </tr>
      <tr>
        <td class='label disabled'>Number of Power Pools:</td>
        <td><input type='number' min='0' max='2' step='1' value='0' disabled></td>
      </tr>
      <tr>
        <td class='label disabled'>Teams per Power Pool:</td>
        <td><input type='number' min='3' max='4' value='3' disabled></td>
      </tr>
      <tr>
        <td class='label'>Locations:</td>
        <td><textarea name="locations" cols="40" rows="6" onchange='onLocationChange()'></textarea></td>
      </tr>
      <tr>
        <td class='label'>Times:</td>
        <td><textarea name="times" cols="10" rows="2" onchange='onTimeChange()'>8:00 AM&NewLine;3:00 PM</textarea></td>
      </tr>
      <tr><td colspan='2'>
        <table class='matrix'>
          <thead></thead>
          <tbody></tbody>
        </table>
      </td></tr>
      <tr>
        <td class='label'>Paste Team List Here:</td>
        <td><textarea name='excel_data' cols='20' rows='1' onchange='onExcelPaste()'></textarea></td>
      </tr>

      <tr><td colspan='2'>
        <tr><td colspan='2'>
            <table class='event'>
              <thead>
                <tr><th colspan='2'></th><th colspan='2'><div class='dynawidth' contenteditable>May 5, 2018</div></th><th colspan='2'><div class='dynawidth' contenteditable>May 6, 2018</div></th></tr>
                <tr><th colspan='2'></th><th><div class='dynawidth' contenteditable>8:00 AM</div></th><th><div class='dynawidth' contenteditable>3:00 PM</div></th><th><div class='dynawidth' contenteditable>8:00 AM</div></th><th><div class='dynawidth' contenteditable>3:00 PM</div></th></tr>
              </thead>
              <tbody>
                <tr><th rowspan='2'></div><div class='dynawidth' contenteditable>Venue 1</div></th><th><div class='dynawidth' contenteditable>Court 1</div></th><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></tr>
                <tr><th><div class='dynawidth' contenteditable>Court 2</div></th><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></tr>
                <tr><th rowspan='2'><div class='dynawidth' contenteditable>Venue 2</div></th><th><div class='dynawidth' contenteditable>Court 1</div></th><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></tr>
                <tr><th><div class='dynawidth' contenteditable>Court 2</div></th><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></td><td><input type='checkbox' checked></tr>
              </tbody>
            </table>
          </td></tr>

        </tbody></table>
    <!--
      [key to track tourney]
      Pool name
      Pool date
      Location/time table
      Table entry field
      Power pools (default ULR?)
      Teams per pool (default 4)
      Pools (default teams / 4)
      Submit button
    -->
    <br><input type="button" onclick="SendEntryDataToServer()" value="Generate Pools"/>
</form>
<div id='excel_table'></div>
</body>